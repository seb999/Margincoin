<div class="grid grid-cols-12 gap-4">
  <!-- Main Column -->
  <div class="col-span-12 lg:col-span-9">
    <!-- Control Bar -->
    <div class="flex flex-wrap items-center justify-between gap-4 mb-4 p-4 bg-gray-800 rounded-lg border border-gray-700">
      <!-- Trading Controls -->
      <div class="flex items-center gap-2">
        <button *ngIf="!isTradeOpen" class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md transition-colors" (click)="trade()">
          <i class="fa-solid fa-play mr-2"></i>Start
        </button>
        <button *ngIf="isTradeOpen" class="px-4 py-2 text-sm font-medium text-white bg-green-800 rounded-md cursor-not-allowed opacity-60" disabled>
          <i class="fa-solid fa-play mr-2"></i>Start
        </button>
        <button class="px-4 py-2 text-sm font-medium text-white bg-yellow-600 hover:bg-yellow-700 rounded-md transition-colors" (click)="stopTrade()">
          <i class="fa-solid fa-pause mr-2"></i>Pause
        </button>
      </div>

      <!-- Status Badges -->
      <div class="flex items-center gap-2">
        <span *ngIf="showMessageInfo" class="px-3 py-1 text-xs font-medium text-yellow-300 bg-yellow-900/50 border border-yellow-700 rounded-full">
          Trading
        </span>
        <span *ngIf="showMessageError" class="px-3 py-1 text-xs font-medium text-red-300 bg-red-900/50 border border-red-700 rounded-full">
          {{messageError}}
        </span>
        <span *ngIf="showMessageExport" class="px-3 py-1 text-xs font-medium text-blue-300 bg-blue-900/50 border border-blue-700 rounded-full">
          {{messageExport}}
        </span>
      </div>

      <!-- Balance & Date Filter -->
      <div class="flex items-center gap-3">
        <div class="text-sm text-gray-300">
          Balance: <span class="font-bold text-white">{{this.balance?.toFixed(0)}}</span>
        </div>
        <div class="flex items-center gap-2">
          <input class="w-32 px-3 py-1.5 text-sm bg-gray-700 border border-gray-600 text-gray-100 rounded-md focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none"
            placeholder="yyyy-mm-dd" name="dp" [(ngModel)]="model" ngbDatepicker #d="ngbDatepicker" (dateSelect)="filterOrderList()">
          <button class="p-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors" (click)="d.toggle();filterOrderList();" type="button">
            <i class="fa-solid fa-calendar-days"></i>
          </button>
          <button class="px-3 py-1.5 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors" (click)="model = today();filterOrderList()">
            Today
          </button>
        </div>
      </div>
    </div>

    <!-- Order Table -->
    <div class="overflow-x-auto rounded-lg border border-gray-700">
      <table class="w-full text-sm">
        <thead class="bg-gray-800">
          <tr>
            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-400 uppercase">Symbol</th>
            <th class="px-3 py-2 text-right text-xs font-semibold text-gray-400 uppercase">Qty</th>
            <th class="px-3 py-2 text-right text-xs font-semibold text-gray-400 uppercase">Open</th>
            <th class="px-3 py-2 text-right text-xs font-semibold text-gray-400 uppercase">Close</th>
            <th class="px-3 py-2 text-right text-xs font-semibold text-gray-400 uppercase">%</th>
            <th class="px-3 py-2 text-right text-xs font-semibold text-gray-400 uppercase">Profit</th>
            <th class="px-3 py-2 text-right text-xs font-semibold text-gray-400 uppercase hidden lg:table-cell">Best P.</th>
            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-400 uppercase hidden xl:table-cell">Open</th>
            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-400 uppercase hidden xl:table-cell">Close</th>
            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-400 uppercase hidden lg:table-cell">Type</th>
            <th class="px-3 py-2 text-right text-xs font-semibold text-gray-400 uppercase hidden lg:table-cell">RSI</th>
            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-400 uppercase">Status</th>
            <th class="px-3 py-2 text-center text-xs font-semibold text-gray-400 uppercase">
              <button class="text-orange-400 hover:text-orange-300" (click)="refreshOrderTable()">
                <i class="fa fa-arrows-rotate"></i>
              </button>
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-700">
          <tr *ngFor="let order of orderList"
              class="hover:bg-gray-800/50 transition-colors"
              [ngClass]="{'bg-yellow-900/20': order.closeDate == null, 'bg-red-900/20': order.status !== 'FILLED'}">
            <td class="px-3 py-2 font-medium text-white">{{order.symbol}}</td>
            <td class="px-3 py-2 text-right text-gray-300">
              <span *ngIf="!order.isClosed">{{(order.quantityBuy*order.openPrice).toFixed(0)}}/0</span>
              <span *ngIf="order.isClosed">{{(order.quantityBuy*order.openPrice).toFixed(0)}}/{{(order.quantitySell*order.closePrice).toFixed(0)}}</span>
            </td>
            <td class="px-3 py-2 text-right">
              <a href="#" class="text-blue-400 hover:text-blue-300" (click)="binanceOrder(order.buyOrderId)">{{order.openPrice.toFixed(5)}}</a>
            </td>
            <td class="px-3 py-2 text-right">
              <a href="#" class="text-blue-400 hover:text-blue-300" (click)="binanceOrder(order.sellOrderId)">{{order.closePrice.toFixed(5)}}</a>
            </td>
            <td class="px-3 py-2 text-right font-mono">
              <span *ngIf="order.closePrice==0" class="text-gray-500">--</span>
              <span *ngIf="(order.closePrice - order.openPrice) >=0 && order.closePrice!=0" class="text-green-400">
                {{(((order.closePrice - order.openPrice) / (order.openPrice))*100).toFixed(2)}}%
              </span>
              <span *ngIf="(order.closePrice - order.openPrice) < 0 && order.closePrice!=0" class="text-red-400">
                {{(((order.closePrice - order.openPrice) / (order.openPrice))*100).toFixed(2)}}%
              </span>
            </td>
            <td class="px-3 py-2 text-right font-mono">
              <span *ngIf="order.closePrice==0" class="text-gray-500">--</span>
              <span *ngIf="((order.closePrice - order.openPrice)*order.quantityBuy) >=0 && order.closePrice!=0" class="text-green-400">
                {{((order.closePrice - order.openPrice)*order.quantityBuy).toFixed(2)}}
              </span>
              <span *ngIf="((order.closePrice - order.openPrice)*order.quantityBuy) < 0 && order.closePrice!=0" class="text-red-400">
                {{((order.closePrice - order.openPrice)*order.quantityBuy).toFixed(2)}}
              </span>
            </td>
            <td class="px-3 py-2 text-right font-mono hidden lg:table-cell">
              <span *ngIf="order.highPrice==0" class="text-gray-500">--</span>
              <span *ngIf="((order.highPrice - order.openPrice)*order.quantityBuy) < 0 && order.highPrice!=0" class="text-red-400">
                {{((order.highPrice - order.openPrice)*order.quantityBuy).toFixed(2)}}
              </span>
              <span *ngIf="((order.highPrice - order.openPrice)*order.quantityBuy) >=0 && order.highPrice!=0" class="text-green-400">
                {{((order.highPrice - order.openPrice)*order.quantityBuy).toFixed(2)}}
              </span>
            </td>
            <td class="px-3 py-2 text-gray-300 hidden xl:table-cell">{{order.openDate}}</td>
            <td class="px-3 py-2 text-gray-300 hidden xl:table-cell">{{order.closeDate}}</td>
            <td class="px-3 py-2 text-gray-300 hidden lg:table-cell">{{order.type}}</td>
            <td class="px-3 py-2 text-right text-gray-300 hidden lg:table-cell">{{order.rsi.toFixed(2)}}</td>
            <td class="px-3 py-2">
              <span class="px-2 py-0.5 text-xs rounded-full"
                [ngClass]="order.status === 'FILLED' ? 'bg-green-900/50 text-green-300' : 'bg-yellow-900/50 text-yellow-300'">
                {{order.status}}
              </span>
            </td>
            <td class="px-3 py-2 text-center">
              <div class="flex items-center justify-center gap-1">
                <button *ngIf="!order.isClosed" class="p-1 text-orange-400 hover:text-orange-300" (click)="closeTrade(order.id, order.closePrice);">
                  <i class="far fa-trash-alt"></i>
                </button>
                <a [routerLink]="['/orderDetail', order.id]" target="_blank" class="p-1 text-orange-400 hover:text-orange-300">
                  <i class="fa-solid fa-chart-line"></i>
                </a>
                <button class="p-1 text-orange-400 hover:text-orange-300" (click)="showChart(order.symbol, order.id);">
                  <i class="fa-solid fa-chart-simple"></i>
                </button>
              </div>
            </td>
          </tr>
          <!-- Totals Row -->
          <tr class="bg-gray-800 font-semibold">
            <td class="px-3 py-2" colspan="4"></td>
            <td class="px-3 py-2 text-right text-white">Total</td>
            <td class="px-3 py-2 text-right font-mono" [ngClass]="(totalProfit ?? 0) >= 0 ? 'text-green-400' : 'text-red-400'">
              {{(totalProfit ?? 0).toFixed(2)}}
            </td>
            <td class="px-3 py-2 text-right font-mono hidden lg:table-cell" [ngClass]="(totalBestProfit ?? 0) >= 0 ? 'text-green-400' : 'text-red-400'">
              {{(totalBestProfit ?? 0).toFixed(2)}}
            </td>
            <td colspan="6"></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Right Sidebar -->
  <div class="col-span-12 lg:col-span-3 space-y-4">
    <!-- Controls Card -->
    <div class="p-4 bg-gray-800 rounded-lg border border-gray-700">
      <div class="flex flex-wrap gap-2 mb-4">
        <button class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors"
          (click)="isCollapsed = !isCollapsed">
          <i class="fa fa-flask mr-1"></i>Logs
        </button>
        <button class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors"
          (click)="clearChart()">
          <i class="fa-solid fa-eraser mr-1"></i>Clear
        </button>
        <button *ngIf="isTradeOpen" class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors"
          (click)="debugBuy()">Buy</button>
        <button *ngIf="isTradeOpen" class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors"
          (click)="syncBinanceSymbol()">Sync</button>
        <button *ngIf="!isTradeOpen" class="px-3 py-1.5 text-xs font-medium text-white bg-gray-600 rounded-md cursor-not-allowed opacity-50" disabled>Buy</button>
        <button *ngIf="!isTradeOpen" class="px-3 py-1.5 text-xs font-medium text-white bg-gray-600 rounded-md cursor-not-allowed opacity-50" disabled>Sync</button>
      </div>

      <!-- Toggles -->
      <div class="flex items-center gap-6">
        <div class="flex items-center gap-2">
          <mat-slide-toggle [(ngModel)]="isMarketOrder" [color]="color" (change)="changeOrderType()"></mat-slide-toggle>
          <span class="text-sm text-white">{{ isMarketOrder ? 'Market' : 'Limit' }}</span>
        </div>
        <div class="flex items-center gap-2">
          <mat-slide-toggle [(ngModel)]="isProd" [color]="color" (change)="changeTradeServer()"></mat-slide-toggle>
          <span class="text-sm" [ngClass]="isProd ? 'text-red-400' : 'text-green-400'">{{ isProd ? 'Prod' : 'Test' }}</span>
        </div>
      </div>
    </div>

    <!-- Chart Settings -->
    <div class="p-4 bg-gray-800 rounded-lg border border-gray-700">
      <div class="flex items-center justify-between mb-3">
        <span class="text-orange-400 font-medium">{{this.displaySymbol}}</span>
        <div class="flex items-center gap-2">
          <span class="text-xs text-gray-400">Slope:</span>
          <span class="text-sm text-white">{{this.slope?.slope.toFixed(2)}}</span>
        </div>
        <select class="px-2 py-1 text-sm bg-gray-700 border border-gray-600 text-gray-100 rounded-md focus:border-blue-500 outline-none"
          [(ngModel)]="interval" (change)="changeHighstockResolution(interval)">
          <option *ngFor="let item of intervalList" [value]="item.value">{{ item.value }}</option>
        </select>
      </div>
      <!-- Chart -->
      <div *ngIf="chartOptions" class="w-full h-64">
        <highcharts-chart #chart constructorType='stockChart' [Highcharts]="highcharts" [options]="chartOptions"
          [callbackFunction]="chartCallback" [update]="updateFlag" style="width: 100%; height: 100%; display: block;">
        </highcharts-chart>
      </div>
    </div>

    <!-- Wallet Assets -->
    <div class="p-4 bg-gray-800 rounded-lg border border-gray-700">
      <h3 class="text-sm font-semibold text-gray-300 uppercase mb-3">Wallet</h3>
      <table class="w-full text-sm">
        <thead>
          <tr class="text-xs text-gray-400 uppercase">
            <th class="pb-2 text-left">Asset</th>
            <th class="pb-2 text-right">Free</th>
            <th class="pb-2 text-right">Locked</th>
            <th class="pb-2 w-16"></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-700">
          <tr *ngFor="let asset of myAccount?.balances" class="hover:bg-gray-700/30">
            <td class="py-2">
              <button class="text-orange-400 hover:text-orange-300 font-medium" (click)="showChart(asset.asset, null);">
                {{asset?.asset}}
              </button>
            </td>
            <td class="py-2 text-right text-gray-300 font-mono">{{formatBalance(asset?.free, asset?.asset)}}</td>
            <td class="py-2 text-right text-gray-300 font-mono">{{formatBalance(asset?.locked, asset?.asset)}}</td>
            <td class="py-2 text-right">
              <div class="flex items-center justify-end gap-1">
                <button *ngIf="+asset?.locked > 0" class="p-1 text-red-400 hover:text-red-300" (click)="cancelSymbolOrder(asset?.asset);">
                  <i class="fa-solid fa-xmark"></i>
                </button>
                <button class="p-1 text-orange-400 hover:text-orange-300" (click)="openPopup(popupTemplate, asset?.asset, asset?.free);">
                  <i class="fa-solid fa-arrow-right-arrow-left"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <p *ngIf="!myAccount?.balances?.length" class="text-center text-gray-500 py-4">No assets</p>
    </div>
  </div>
</div>

<!-- Order Popover Template -->
<ng-template #popTitle let-order="order">
  <div class="flex items-center gap-2">
    <span *ngIf="order?.side == 'BUY'" class="px-2 py-0.5 text-xs font-medium bg-green-600 text-white rounded">{{order?.side}}</span>
    <span *ngIf="order?.side == 'SELL'" class="px-2 py-0.5 text-xs font-medium bg-red-600 text-white rounded">{{order?.side}}</span>
    <span class="font-bold">{{order?.symbol}}</span>
  </div>
</ng-template>
<ng-template #popContent let-order="order">
  <div class="space-y-2 text-sm">
    <div class="flex justify-between"><span class="text-gray-400">QuoteQty</span><span class="font-medium">{{order?.cummulativeQuoteQty}}</span></div>
    <div class="flex justify-between"><span class="text-gray-400">Status</span><span class="font-medium">{{order?.status}}</span></div>
    <div class="flex justify-between"><span class="text-gray-400">Price</span><span class="font-medium">{{order?.price}}</span></div>
    <div class="flex justify-between"><span class="text-gray-400">Quantity</span><span class="font-medium">{{order?.executedQty}}</span></div>
    <div class="flex justify-between"><span class="text-gray-400">Fee</span><span class="font-medium">{{order?.fee}}</span></div>
  </div>
</ng-template>
<div class="fixed right-40 bottom-64" [ngbPopover]="popContent" [popoverTitle]="popTitle" triggers="manual" placement="bottom" #p1="ngbPopover"></div>

<!-- Buy/Sell Modal -->
<ng-template #popupTemplate let-modal>
  <div class="bg-gray-800 rounded-lg border border-gray-700 shadow-xl">
    <div class="flex items-center justify-between px-4 py-3 border-b border-gray-700">
      <h3 class="text-lg font-semibold text-white">
        <span class="px-2 py-1 text-xs font-medium bg-gray-600 text-white rounded">SELL / BUY</span>
      </h3>
      <button type="button" class="text-gray-400 hover:text-white" aria-label="Close" (click)="modal.dismiss('Cross click')">
        <i class="fa-solid fa-xmark text-xl"></i>
      </button>
    </div>
    <div class="p-4">
      <form class="space-y-4">
        <div class="flex items-baseline gap-2 mb-4">
          <span class="text-xl font-bold text-white">{{this.popupSymbol}}</span>
          <span class="text-sm text-gray-400">{{this.popupSymbolPrice}} USDT</span>
        </div>
        <div class="flex items-center gap-3">
          <label for="qty" class="w-24 text-sm text-gray-300">Qty</label>
          <input id="qty" class="flex-1 px-3 py-2 text-sm bg-gray-700 border border-gray-600 text-white rounded-md focus:border-blue-500 outline-none"
            name="qty" required [(ngModel)]="this.popupQty" (ngModelChange)="onPopupQtyChange()">
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md transition-colors"
            (click)="modal.close('sell')">Sell Market</button>
        </div>
        <div class="flex items-center gap-3">
          <label for="quoteQty" class="w-24 text-sm text-gray-300">Quote Qty</label>
          <input id="quoteQty" class="flex-1 px-3 py-2 text-sm bg-gray-700 border border-gray-600 text-white rounded-md focus:border-blue-500 outline-none"
            name="quoteQty" required [(ngModel)]="this.popupQuoteQty" (ngModelChange)="onPopupQuoteQtyChange()">
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md transition-colors"
            (click)="modal.close('buy')">Buy Market</button>
        </div>
      </form>
    </div>
    <div class="flex justify-end px-4 py-3 border-t border-gray-700">
      <button type="button" class="px-4 py-2 text-sm font-medium text-white bg-gray-600 hover:bg-gray-700 rounded-md transition-colors"
        (click)="modal.dismiss()" ngbAutofocus>Cancel</button>
    </div>
  </div>
</ng-template>

<!-- Logs Panel -->
<div class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-700" #collapse="ngbCollapse" [(ngbCollapse)]="isCollapsed">
  <div class="max-w-7xl mx-auto p-4">
    <div class="flex items-start gap-2">
      <button class="p-1 text-orange-400 hover:text-orange-300" (click)="refreshUI()">
        <i class="fa fa-arrows-rotate"></i>
      </button>
      <ul class="flex-1 h-36 overflow-y-auto text-sm text-gray-300 space-y-1">
        <li *ngFor="let item of logList" class="py-0.5">{{item}}</li>
      </ul>
    </div>
  </div>
</div>